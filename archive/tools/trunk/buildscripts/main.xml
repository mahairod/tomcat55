<project name="source-snapshots" default="tomcat" basedir=".">
   <!-- ******************** Initialization ******************** -->
   <target name="init">
    <tstamp />
    <property name="ws.dir" value="${user.home}/ws" />
    <!-- keep it in sync with jakarta-apache.xml -->
    <property name="nightly.url" value="http://jakarta.apache.org/builds/tomcat/nightly" />
    <property name="tomcat.home" value="${user.home}/opt/tomcat" />
    <property name="dist.dir" value="${user.home}/opt" />
    <property name="package.dir" value="${user.home}/public_html" />
    <!-- Allow user to override any of the hardcoded directories -->
    <property file="${user.home}/.ant.properties" />
  </target>

  <target name="clean.src">
     <deltree dir="${ws.dir}/jakarta-tomcat" />
     <deltree dir="${ws.dir}/jakarta-watchdog" />
     <deltree dir="${ws.dir}/jakarta-tools" />
     <deltree dir="${ws.dir}/jakarta-tomcat.src.zip" />
     <deltree dir="${ws.dir}/jakarta-tools.src.zip" />
     <deltree dir="${ws.dir}/jakarta-watchdog.src.zip" />
  </target>

  <target name="clean">
     <deltree dir="${ws.dir}/build" />
     <deltree dir="${ws.dir}/dist" />
     <deltree dir="${dist.dir}/ant" />
     <deltree dir="${dist.dir}/tomcat" />
  </target>

  <target name="prepare">
    <mkdir dir="${ws.dir}" />
   </target>
   <!-- ******************** Getting sources ******************** -->
  <target name="tomcat.get" depends="prepare">
    <get src="${nightly.url}/src/jakarta-tomcat.src.zip" dest="${ws.dir}/jakarta-tomcat.src.zip" />
    <expand src="${ws.dir}/jakarta-tomcat.src.zip" dest="${ws.dir}" />
  </target>
  
  <target name="tools.get" depends="prepare">
    <get src="${nightly.url}/src/jakarta-tools.src.zip" dest="${ws.dir}/jakarta-tools.src.zip" />
    <expand src="${ws.dir}/jakarta-tools.src.zip" dest="${ws.dir}" />
  </target>

  <target name="watchdog.get" depends="prepare">
    <get src="${nightly.url}/src/jakarta-watchdog.src.zip" dest="${ws.dir}/jakarta-watchdog.src.zip" />
    <expand src="${ws.dir}/jakarta-watchdog.src.zip" dest="${ws.dir}" />
  </target>

   <!-- ******************** Building  ******************** -->
  <target name="tomcat">
     <ant dir="${ws.dir}/jakarta-tomcat" antfile="${ws.dir}/jakarta-tomcat/build.xml" target="package" />
     <copyfile src="${package.dir}/tomcat/tomcat.zip" dest="${package.dir}/tomcat/tomcat-${os.name}-${DSTAMP}.zip" />
     <copyfile src="${package.dir}/tomcat/tomcat.zip" dest="${package.dir}/tomcat/tomcat-${DSTAMP}.zip" />
  </target>

  <target name="ant">
     <ant dir="${ws.dir}/jakarta-tools/ant" antfile="${ws.dir}/jakarta-tools/ant/build.xml" target="package" /> 
     <copyfile src="${package.dir}/ant/ant.zip" dest="${package.dir}/ant/ant-${os.name}-${DSTAMP}.zip" />
     <copyfile src="${package.dir}/ant/ant.zip" dest="${package.dir}/ant/ant-${DSTAMP}.zip" />
   </target>

   <target name="test-build">
     <ant dir="${ws.dir}/jakarta-tomcat" antfile="${ws.dir}/jakarta-tomcat/build.xml" target="test" />
   </target>

   <target name="watchdog">
     <ant dir="${ws.dir}/jakarta-watchdog" antfile="${ws.dir}/jakarta-watchdog/build.xml" target="dist" />
   </target>

   <!-- ******************** Testing  ******************** -->
   <target name="tomcat-test">
     <exec dir="${ws.dir}/build/tomcat/test" command="sh runtest.sh " output="${package.dir}/tomcat/tomcat-test.log" />
   </target>

   <target name="watchdog-test">
     <exec dir="${ws.dir}/build/watchdog" command="sh runtest.sh  " output="${package.dir}/tomcat/watchdog-test.log" />
   </target>

   <target name="test-apache">
     <exec dir="${ws.dir}" command="/usr/local/apache/bin/apachectl start" />
     <exec dir="${ws.dir}/build/tomcat/test" command="sh runtest.sh " output="${package.dir}/tomcat/tomcat-test.log" />
     <exec dir="${ws.dir}/build/watchdog" command="sh runtest.sh  " output="${package.dir}/tomcat/watchdog-test.log" />
     <exec dir="${ws.dir}" command="/usr/local/apache/bin/apachectl stop" />
   </target>


   <!-- ******************** Platform specific packages  ******************** -->
   <target name="pkg" > 
     <exec os="SunOS" dir="${ws.dir}/jakarta-tomcat/src/etc" command="pkgmk -f prototype -d ${ws.dir}/build  -r / " />
     <zip zipfile="${package.dir}/tomcat/ASFtomcat-pkg.zip" 
         basedir="${ws.dir}/build"
         items="ASFtomcat" />

     <exec os="SunOS" dir="${ws.dir}/jakarta-tools/ant/src/etc" command="pkgmk -f prototype -d ${ws.dir}/build  -r / " />
     <zip zipfile="${package.dir}/ant/ASFant-pkg.zip" 
         basedir="${ws.dir}/build"
         items="ASFant" />
  </target>


  <target name="rpm" > 
    <copyfile src="${ws.dir}/jakarta-tomcat.src.zip" dest="/usr/src/redhat/SOURCES/jakarta-tomcat.src.zip" />
    <copyfile src="${ws.dir}/jakarta-tools.src.zip" dest="/usr/src/redhat/SOURCES/jakarta-tools.src.zip" />
    <exec os="Linux" dir="${ws.dir}" command="rpm -ba --target noarch ${ws.dir}/jakarta-tomcat/src/etc/tomcat.spec " />
    <exec os="Linux" dir="${ws.dir}" command="rpm -ba --target noarch ${ws.dir}/jakarta-tools/ant/src/etc/ant.spec " />
    <copyfile src="/usr/src/redhat/RPMS/noarch/tomcat-3.0-0.noarch.rpm" dest="${package.dir}/tomcat/tomcat-3.0-0.noarch.rpm" />
    <copyfile src="/usr/src/redhat/SRPMS/tomcat-3.0-0.src.rpm" dest="${package.dir}/tomcat/tomcat-3.0-0.src.rpm" />
    <copyfile src="/usr/src/redhat/RPMS/noarch/ant-1.0-0.noarch.rpm" dest="${package.dir}/ant/ant-1.0-0.noarch.rpm" />
    <copyfile src="/usr/src/redhat/SRPMS/ant-3.0-0.src.rpm" dest="${package.dir}/ant/ant-1.0-0.src.rpm" />
  </target>

   <!-- ******************** Agregate targets  ******************** -->
  <target name="get.all" depends="clean.src,tomcat.get,tools.get,watchdog.get">
  </target>

  <target name="build" depends="tomcat,ant,tomcat,ant,test-build,watchdog">
  </target>

  <target name="all" depends="clean,get.all,build">
  </target>

  <target name="test" depends="tomcat-test,watchdog-test">
  </target>
  
</project>

