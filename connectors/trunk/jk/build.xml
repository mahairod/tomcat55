<project name="jk" default="build-main" basedir=".">
  
    <!-- We'll build jk for 3.3 or 4.0 ( depending on what you have installed ).
    You need to set tomcat40.home and/or tomcat33.home in build.properties
    ( either the path to 'official' distribution or the development dirs )
    -->
  
    <!-- ===================== Initialize Property Values ================ -->
    <property file="build.properties"/>
    <property file="${user.home}/build.properties"/>
    <property file="${user.home}/.build.properties"/>

    <property name="jk.build" location="${basedir}/build"/>

    <!-- Compile options -->
    <property name="optimize" value="off" />
    <property name="debug" value="on" />

    <!-- default locations -->
    <property name="tomcat33.home" 
	      location="../../jakarta-tomcat/build/tomcat" />
    <property name="tomcat40.home" 
	      location="../../jakarta-tomcat-4.0/build" />
    <property name="tomcat41.home" 
	      location="../../jakarta-tomcat-4.1/build" />
    
    <!-- ==================== Detection and reports ==================== -->

    <target name="report"  >
        <echo message="Tomcat33: ${tomcat33.detect} ${tomcat33.home}" />
        <echo message="Tomcat40:  ${tomcat40.detect} ${tomcat40.home}" />
        <echo message="Tomcat41: ${tomcat41.detect} ${tomcat41.home}" />
        <echo message="Apache13: ${apache13.detect} ${apache13.home}" />
        <echo message="Apache2: ${apache2.detect} ${apache2.home}" />
        <echo message="iPlanet:  ${iplanet.detect} ${iplanet.home}" />
        <echo message="IIS:      ${iis.detect} ${iis.home}" />
        <echo message="Using catalina.home:      ${catalina.home}" />
    </target>

    <target name="detect" >
        <available property="tomcat33.detect" 
                   file="${tomcat33.home}/lib/common/tomcat_core.jar" />
        <available property="tomcat40.detect" 
                   file="${tomcat40.home}/server/lib/catalina.jar" />
        <available property="tomcat41.detect" 
                   file="${tomcat41.home}/server/webapps" />
        <available property="apache13.detect" 
                   file="${apache13.home}" />
        <available property="apache2.detect" 
                   file="${apache2.home}" />
        <available property="iis.detect" 
                   file="${iis.home}" />
        <available property="iplanet.detect" 
                   file="${iplanet.home}" />
    </target>

    <target name="cpath" depends="guess_catalina40,guess_catalina41" />
    <!-- If both 4.0 and 4.1 are present ( developer machine ), use 4.1 jars.
         If only 4.0 is present or
         If only 4.1 is present - use what's available.
     -->

    <target name="guess_catalina40" unless="tomcat41.detect">
        <property name="catalina.home" 
                  location="${tomcat40.home}" />
    </target>

    <target name="guess_catalina41" if="tomcat41.detect">
        <property name="catalina.home" 
                  location="${tomcat41.home}" />
    </target>

    <target name="prepare" depends="detect,cpath" >
        <mkdir dir="${jk.build}"/>
        <mkdir dir="${jk.build}/WEB-INF"/>
        <mkdir dir="${jk.build}/WEB-INF/conf"/>
	<mkdir dir="${jk.build}/WEB-INF/classes"/>
        <mkdir dir="${jk.build}/WEB-INF/classes/META-INF" />
	<mkdir dir="${jk.build}/WEB-INF/lib"/>
        <copy file="conf/web.xml" tofile="${jk.build}/WEB-INF/web.xml" />
	<copy todir="${jk.build}/WEB-INF" file="interceptors.xml"/>
	<copy todir="${jk.build}/WEB-INF/conf" >
	    <fileset dir="conf" includes="*" />
	</copy>

        <path id="build-main.classpath">
            <pathelement location="${catalina.home}/server/lib/catalina.jar"/>
            <pathelement location="${catalina.home}/common/lib/servlet.jar"/>
            <pathelement location="${tomcat33.home}/lib/common/tomcat_core.jar"/>
            <pathelement location="${tomcat33.home}/lib/common/core_util.jar"/>
            <pathelement 
                         location="${tomcat33.home}/lib/container/tomcat_modules.jar"/>
            <pathelement 
                         location="${tomcat33.home}/lib/container/tomcat_util.jar"/>
        </path>

    </target>

    <target name="build-main" 
            depends="prepare,report,jkutil,jkjava,jkant" />

    <!-- ==================== Building ==================== -->

    <target name="jkjava" 
            description="Build java side of the connector" >
        <javac srcdir="java"
	       destdir="${jk.build}/WEB-INF/classes"
	       deprecation="off"
	       debug="${debug}"
	       optimize="${optimize}"
	       verbose="off" >
	    <exclude name="org/apache/ajp/tomcat4/**" unless="tomcat40.detect"/>
            <exclude name="org/apache/ajp/tomcat33/**" unless="tomcat33.detect"/>
            <exclude name="org/apache/jk/server/tomcat33/**" unless="tomcat33.detect"/>
            <exclude name="org/apache/jk/server/tomcat40/**" unless="tomcat40.detect"/>
	    <exclude name="org/apache/catalina/**" unless="tomcat40.detect"/>
	    <classpath refid="build-main.classpath"/>
	</javac>

	<!-- Copy static resource files -->
	<copy todir="${jk.build}/WEB-INF/classes">
	    <fileset dir="java">
	    	<include name="**/*.properties"/>
	    </fileset>
        </copy>

	<jar jarfile="${jk.build}/WEB-INF/lib/tomcat-ajp.jar"
	     basedir="${jk.build}/WEB-INF/classes">
            <include name="org/apache/ajp/**" />
        </jar>
	
	<jar jarfile="${jk.build}/WEB-INF/lib/tomcat-ajp2.jar"
	     basedir="${jk.build}/WEB-INF/classes">
            <include name="org/apache/jk/**" />
            <exclude name="org/apache/jk/ant/**" />
        </jar>
	
    </target>
    
    <target name="jkant" >
	<javac srcdir="jkant/java" 
	       destdir="${jk.build}/WEB-INF/classes" 
	       debug="${debug}"
	       optimize="${optimize}"
	       verbose="off" >
	</javac>
	<copy todir="${jk.build}/WEB-INF/classes/META-INF" 
              file="jkant/ant.tasks"/>
	<jar jarfile="${jk.build}/WEB-INF/lib/jkant.jar"
	     basedir="${jk.build}/WEB-INF/classes" >
            <include name="org/apache/jk/ant/**" />
            <include name="META-INF/ant.tasks" />
        </jar>
    </target>
    
    <target name="jkutil" 
            description="Build utils" >
	<javac srcdir="../util/java" 
	       destdir="${jk.build}/WEB-INF/classes" 
	       debug="${debug}"
	       optimize="${optimize}"
	       verbose="off" >
	</javac>

	<!-- Copy static resource files -->
	<copy todir="${jk.build}/WEB-INF/classes">
	    <fileset dir="../util/java">
	    	<include name="**/*.properties"/>
	    </fileset>
        </copy>

	<jar jarfile="${jk.build}/WEB-INF/lib/tomcat-util.jar"
	     basedir="${jk.build}/WEB-INF/classes" >
            <include name="org/apache/tomcat/util/**" />
        </jar>
    </target>

    <!-- It's better to call it directly with individual tags -->
    <target name="native" depends="jkant" >
	<ant  dir="native" antfile="build.xml"  />
	<ant  dir="native2" antfile="build.xml"  />
    </target>

    <!-- ================ Install =================== -->

    <target name="install" 
            depends="prepare,build-main,install-t33,install-t40,install-t41,install-a20,install-a13" />

    <target name="install-t33" if="tomcat33.detect" > 
        <mkdir dir="${tomcat33.home}/modules/jk" />
        <copy todir="${tomcat33.home}/modules/jk" >
            <fileset dir="${jk.build}" >
                <include name="WEB-INF/lib/**" />
                <include name="WEB-INF/conf/**" />
                <include name="WEB-INF/interceptors.xml" />
            </fileset>
        </copy>
    </target>

    <target name="install-t40" if="tomcat40.detect" > 
        <copy todir="${tomcat40.home}/server/lib" 
              file="${jk.build}/WEB-INF/lib/tomcat-util.jar"/>
        <copy todir="${tomcat40.home}/server/lib" 
              file="${jk.build}/WEB-INF/lib/tomcat-ajp.jar"/>
        <copy todir="${tomcat40.home}/server/lib" 
              file="${jk.build}/WEB-INF/lib/tomcat-ajp2.jar"/>
    </target>

    <target name="install-t41" if="tomcat41.detect" > 
        <!-- 4.0 style --> 
        <copy todir="${tomcat41.home}/server/lib" 
              file="${jk.build}/WEB-INF/lib/tomcat-util.jar"/>
        <copy todir="${tomcat41.home}/server/lib" 
              file="${jk.build}/WEB-INF/lib/tomcat-ajp.jar"/>
        <copy todir="${tomcat41.home}/server/lib" 
              file="${jk.build}/WEB-INF/lib/tomcat-ajp2.jar"/>
        <echo message="Don't forget to add the connector to ${tomcat41.home}/conf/server.xml" />

        <!-- 3.3 style -->
        <mkdir dir="${tomcat41.home}/server/webapps/jk" />
        <copy todir="${tomcat41.home}/server/webapps/jk" >
            <fileset dir="${jk.build}" >
                <include name="WEB-INF/lib/**" />
                <include name="WEB-INF/conf/**" />
                <include name="WEB-INF/web.xml" />
            </fileset>
        </copy>
        
        <copy file="conf/webapp_41.xml" 
              tofile="${tomcat41.home}/webapps/jk.xml" />
    </target>

    <target name="install-a20" if="apache2.detect" > 
        <!--
    <copy file="${jk.build}/WEB-INF/jk/mod_jk.so" 
              tofile="${apache2.home}/modules/mod_jk.so" />
        -->
    </target>

    <target name="install-a13" if="apache13.detect" > 
    </target>

    <!-- ================ javadocs =================== -->
    <target name="javadoc">
        <delete dir="${jk.build}/javadoc"/>
	<mkdir dir="${jk.build}/javadoc"/>
	<javadoc packagenames="org.apache.ajp,org.apache.ajp.tomcat4"
                 sourcepath="java"
                 classpath="${tomcat-util.jar}:${tomcat40.home}/server/lib/catalina.jar:${tomcat40.home}/common/lib/servlet.jar"
                 destdir="${jk.build}/javadoc"
                 author="true"
                 version="true"
                 windowtitle="Jk Connector Documentation"
                 doctitle="Jk Connector"
                 bottom="Copyright &#169; 2001 Apache Software Foundation.  All Rights Reserved."
	/>
    </target>

    <!-- ==================== Tests ==================== -->
    <!-- XXX move test to it's own dir -->

    <!-- Should all tests fail if one does? -->
    <property name="test.failonerror" value="true"/>
    <!-- The test runner to execute -->
    <property name="test.runner" value="junit.textui.TestRunner"/>
    <property name="test.entry" value="org.apache.ajp.test.TestAll"/>

    <path id="test.classpath">
        <pathelement location="${jk.build}/WEB-INF/classes"/>
	<pathelement location="${tomcat-util.jar}"/>
	<pathelement location="${junit.jar}"/>
    </path>


    <target name="test" if="test.entry" depends="build-main"
            description="Run all unit test cases">
	<java classname="${test.runner}" fork="yes"
	      failonerror="${test.failonerror}">
	      <arg value="${test.entry}"/>
	      <classpath refid="test.classpath"/>
	</java>
    </target>


    <target name="clean">
        <delete dir="${jk.build}"/>
    </target>

</project>
