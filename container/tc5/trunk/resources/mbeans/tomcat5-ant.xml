<project name="tomcat-embed" default="start" basedir=".">

  <property file="${user.home}/build.properties"/>
  <property file="build.properties"/>

  <property name="tomcat.home" location="." />

  <path id="tomcatCP-extra" /> 


  <target name="init" unless="init.done">

    <path id="tomcatCP" >
      <path refid="tomcatCP-extra"/>

      <!-- Just include everything for now 
       -->
      <fileset dir="${tomcat.home}/lib" includes="*.jar"/>
    </path>

    <taskdef resource="org/apache/commons/modeler/ant/ant.properties"
             classpathref="tomcatCP" />
    <property name="init.done" value="true"/>
  </target>


  <!-- ==================== Console - for debugging. ==================== 
       Call this target if you want the console added.
    -->

  <target name="jmx-console-ri" depends="init" description="Enable JMX-RI console ( web interface )" >

    <jmx-service>
      <mbean code="com.sun.jdmk.comm.HtmlAdaptorServer"
             name="jmx-console:type=HtmlAdaptorServer,port=9998">
         <attribute name="Port" value="9998"/>
     </mbean>
    </jmx-service>    

  </target>

  <target name="jmx-console-mx4j" depends="init" description="Enable JMX console ( mx4j )" >

    <jmx-service>
      <mbean code="mx4j.adaptor.http.XSLTProcessor"
             name="Http:name=XSLTProcessor">
      </mbean>
      <mbean code="mx4j.adaptor.http.HttpAdaptor"
             name="Http:name=HttpAdaptor">
         <attribute name="Port" value="9998"/>
         <attribute name="ProcessorName" value="Http:name=XSLTProcessor"/>
     </mbean>
    </jmx-service>    

  </target>


  <!-- ======================= Server.xml based ================ -->
  <property name="domain" value="Catalina" />

  <target name="run" depends="init"
        description="Start tomcat as an mbean using server.xml config and returns">


    <jmx-service>
       <mbean code="org.apache.catalina.startup.Catalina"
              name="${domain}:type=server" 
              modeler="true" >
         <attribute name="catalinaHome"
                    value="${tomcat.home}"/>
       </mbean>
    </jmx-service>

    <echo message="Tomcat5 running"/>

    <!-- let's add a context - using JMX. 
         That will fail with class loader problems... XXX 
      -->

    <jmx-service>
       <mbean name="${domain}:j2eeType=WebModule,name=//localhost/servlet-examples,J2EEApplication=none,J2EEServer=none" 
              code="org.apache.catalina.core.StandardContext"
              modeler="true">
         <attribute name="docBase"
                    value="/ws/50/build/webapps/servlet-examples" />
       </mbean>
    </jmx-service>
    
  </target>

  <!-- ==================== Await ==================== 
       Call this target if you want the build file to hung in "await". Tomcat stop or ^C will stop 
       the ant execution
    -->
  <target name="await" depends="init"
        description="Wait for tomcat stop. Call this target after run">

    <jmx objectName="${domain}:type=server"
         operation="await" />

  </target>

  <target name="start" depends="init,run,await" description="Start tomcat, wait for stop message"/>

</project>
