<project name="tomcat-embed" default="start" basedir=".">

  <property file="${user.home}/build.properties"/>
  <property file="build.properties"/>

  <property name="tomcat.home" location="." />

  <path id="tomcatCP-extra" /> 


  <target name="init" unless="init.done">

    <path id="tomcatCP" >
      <path refid="tomcatCP-extra"/>

      <!-- Just include everything for now 
       -->
      <fileset dir="${tomcat.home}/lib" includes="*.jar"/>
      <pathelement  path="${tomcat.home}/conf"/>
    </path>

    <taskdef resource="org/apache/commons/modeler/ant/ant.properties"
             classpathref="tomcatCP" />
    <property name="init.done" value="true"/>

    <available classname="com.sun.jdmk.comm.HtmlAdaptorServer"
               property="jmxritools-available" 
               classpathref="tomcatCP" />

    <available classname="mx4j.adaptor.http.XSLTProcessor"
               property="mx4jtools-available" 
               classpathref="tomcatCP" />
  </target>


  <!-- ==================== Console - for debugging. ==================== 
       Call this target if you want the console added.
    -->

  <target name="jmx-console" depends="jmx-console-ri,jmx-console-mx4j" />

  <target name="jmx-console-ri" 
          depends="init" 
          description="Enable JMX-RI console ( web interface )" 
          if="jmxritools-available">

    <jmx-service>
      <mbean code="com.sun.jdmk.comm.HtmlAdaptorServer"
             name="jmx-console:type=HtmlAdaptorServer,port=9998">
         <attribute name="Port" value="9998"/>
     </mbean>
    </jmx-service>    

  </target>

  <target name="jmx-console-mx4j" 
          depends="init" 
          description="Enable JMX console ( mx4j )" 
          if="mx4jtools-available">

    <jmx-service>
      <mbean code="mx4j.adaptor.http.XSLTProcessor"
             name="Http:name=XSLTProcessor">
      </mbean>
      <mbean code="mx4j.adaptor.http.HttpAdaptor"
             name="Http:name=HttpAdaptor">
         <attribute name="Port" value="9998"/>
         <attribute name="ProcessorName" value="Http:name=XSLTProcessor"/>
     </mbean>
    </jmx-service>    

  </target>


  <!-- ======================= Server.xml based ================ -->
  <property name="domain" value="Catalina" />

  <target name="run" depends="init"
        description="Start tomcat as an mbean using server.xml config and returns">

    <jmx-service>
       <mbean code="org.apache.catalina.startup.Catalina"
              name="${domain}:type=server" 
              modeler="true" >
         <attribute name="catalinaHome"
                    value="${tomcat.home}"/>
       </mbean>
    </jmx-service>

    <echo message="Tomcat5 running"/>
  </target>


  <target name="run2" depends="init,jmx-console"
        description="Start tomcat as an mbean, no server.xml">

    <modelerRegistry resource="org/apache/catalina/mbeans/mbeans-descriptors.xml" />


    <jmx-service>
<!--
      Should be optional - but the name is used in several places.
      The whole name should disapear - use domain instead
-->
       <mbean name="${domain}:type=Service" 
              code="org.apache.catalina.core.StandardService"
              modeler="true">
         <attribute name="name" value="Tomcat-Standalone"/>
       </mbean>


       <mbean name="${domain}:type=Engine" 
              code="org.apache.catalina.core.StandardEngine"
              modeler="true">
         <attribute name="name" value="Tomcat-Standalone"/>
         <attribute name="baseDir" value="/opt/50"/>
         <attribute name="defaultHost" value="localhost"/>
       </mbean>

       <mbean name="${domain}:type=Realm" 
              code="org.apache.catalina.realm.JAASRealm" modeler="true">
       </mbean>

<!--
       <mbean name="${domain}:type=Connector,port=9009" 
              code="org.apache.coyote.tomcat5.CoyoteConnector"
              modeler="true">
         <attribute name="protocolHandlerClassName"
                    value="org.apache.jk.server.JkCoyoteHandler" />
       </mbean>
-->


       <mbean name="${domain}:type=Connector,port=9080" 
              code="org.apache.coyote.tomcat5.CoyoteConnector"
              modeler="true">
          <attribute name="port" value="9080" />
       </mbean>


<!--
       <mbean name="${domain}:type=DefaultContext,host=localhost,service=Tomcat-Standalone" 
              code="org.apache.catalina.core.StandardDefaultContext"
              modeler="true">
       </mbean>
-->


<!-- Optional: when the context is created it'll create a host if none is found.
-->
       <mbean name="${domain}:type=Host,host=localhost" 
              code="org.apache.catalina.core.StandardHost" modeler="true">
         <attribute name="name" value="localhost"/>
       </mbean>


       <mbean name="${domain}:j2eeType=WebModule,name=//localhost/,J2EEApplication=none,J2EEServer=none" 
              code="org.apache.catalina.core.StandardContext"  modeler="true">
         <attribute name="docBase" value="/opt/50/webapps/ROOT" />
         <!-- Required for now -->
         <attribute name="privileged" value="true" />
       </mbean>

       <mbean name="${domain}:j2eeType=WebModule,name=//localhost/servlets-examples,J2EEApplication=none,J2EEServer=none" 
              code="org.apache.catalina.core.StandardContext"  modeler="true">
         <attribute name="docBase" value="/opt/50/webapps/servlets-examples" />
         <!-- Required for now -->
         <attribute name="privileged" value="true" />
       </mbean>

       <mbean name="${domain}:j2eeType=WebModule,name=//localhost/jsp-examples,J2EEApplication=none,J2EEServer=none" 
              code="org.apache.catalina.core.StandardContext"  modeler="true">
         <attribute name="docBase" value="/opt/50/webapps/jsp-examples" />
         <!-- Required for now -->
         <attribute name="privileged" value="true" />
       </mbean>

<!--
       <mbean name="${domain}:j2eeType=WebModule,name=//localhost/admin,J2EEApplication=none,J2EEServer=none" 
              code="org.apache.catalina.core.StandardContext"  modeler="true">
         <attribute name="docBase" value="/opt/50/server/webapps/admin" />
         <attribute name="privileged" value="true" />
       </mbean>
-->

    </jmx-service>


    <echo message="Tomcat5 running"/>

    <!-- XXX hack - I need to make the threads non-daemon -->
    <sleep hours="1"/>

  </target>

  <!-- ==================== Await ==================== 
       Call this target if you want the build file to hung in "await". Tomcat stop or ^C will stop 
       the ant execution
    -->
  <target name="await" depends="init"
        description="Wait for tomcat stop. Call this target after run">
    <jmx objectName="${domain}:type=server"
         operation="await" />
  </target>

  <target name="start" depends="init,run,await" description="Start tomcat, wait for stop message"/>

</project>
