                  Apache Tomcat Version 4.0 Beta 4
                  =================================
                            Release Notes
                            =============

$Id$


============
INTRODUCTION:
============


This document describes the changes that have been made in the current
beta release of Apache Tomcat, relative to the previous release.

Bug reports should be entered at the interim bug reporting system for
Jakarta projects at:

        http://nagoya.apache.org/bugzilla/

Please use project codes "Catalina" and "Jasper" for servlet-related and
JSP-related bug reports, respectively.


============
NEW FEATURES:
============


---------------------
Catalina New Features:
---------------------

DTD Changes:  Catalina now supports the most recent changes to the web
application deployment descriptor approved by the JSR-053 expert group:
* The <run-as> element now has <description> and <role-name> subelements.
* The new <local-ejb-ref> element (and associated subelements) supports
  the optional EJB feature of local EJBs.

PersistentManager:  You can now configure the persistent session manager
(along with an appropriate Store implementation) in the server.xml file.
Added an example of this, commented out by default.

Manager/Session:  Refactor to eliminate dependencies by StandardManager,
ManagerBase, and StandardSession on each other.


-------------------
Jasper New Features:
-------------------


--------------------
Webapps New Features:
--------------------

SsiInvokerServlet:  Can now be configured for virtual paths to be relative
to the server's document root (the default, for NCSA compatibility) or the
current web application's context root (for convenience when using web apps).


==========================
BUG FIXES AND IMPROVEMENTS:
==========================


------------------
Catalina Bug Fixes:
------------------

Base64:  Update to the new version of the Xerces Base64 encoder/decoder.
The old one had problems encoding binary content.

Catalina:  Do not set an initial context factory.

Naming:  Make the initial context factory available during the init() method
of a <load-on-startup> servlet.

ApplicationContext:  Fix for Bugzilla #1219.  Previously, different web apps
that used JAR files with the same name in their WEB-INF/lib directories could
get access to classes from the wrong JAR file.

StandardClassLoader:  Change the way that security manager permissions are
defined (for each web app) to account for the changes in the previous fix for
cross-webapp JAR files.

ApplicationFilterChain:  If a filter or servlet throws a security exception
(when run under a security manager), make the rethrown ServletException more
useful by including the actual exception as a root cause.

Bootstrap:  Set the Catalina class loader as the thread context class loader.

catalina.policy:  Update the default security manager policies to reflet the
fact that "${java.home}" on some JVMs actually points at "$JAVA_HOME/jre"
instead of "$JAVA_HOME".


----------------
Jasper Bug Fixes:
----------------


-----------------
Webapps Bug Fixes:
-----------------

WebdavServlet:  Fix thread safety problems with the WebDAV servlet.  The JAXP
document builder is not thread-safe, but it was being reused.  Now, a new
instance is created on each request.

DefaultServlet:  Path "/." was not normalized properly (even though "/./" was).

WebdavServlet:  Prevent /WEB-INF and /META-INF from being deleted, or the
contents of these directories from being modified, if read/write
access is enabled.  This is *not* enabled by default.


============================
KNOWN ISSUES IN THIS RELEASE:
============================


------------------------------------------
Redeploying From a Web Application Archive:
------------------------------------------

If you attempt to undeploy, then redeploy, an application from the same
web application archive file URL (where the URL refers to an actual WAR
file, not to a directory), the redeploy will fail with error "zip file is
closed".  There appears to be a problem in the JDK's JarURLConnection class
where JAR files are cached, even after they are closed, so that a request
for a connection to the same URL returns the previous JarFile object instead
of a new one.  As a workaround, you should do one of the following:
* Change the URL of the web application archive each time you redeploy.
* Deploy from an unpacked directory (on the same server) instead of from
  a WAR file (this is often more convenient in a development environment
  anyway).


--------------------------
Tomcat 4.0 and XML Parsers:
--------------------------

Previous versions of Tomcat 4.0 exposed the XML parser used by Jasper (the
JAXP/1.1 reference implementation) to web applications.  This is no longer
the case, because Jasper loads its parser with a new class loader instead.
Keep the following points in mind when considering how to use XML parsers
in Tomcat 4.0 and your web applications:

* If you wish to make the JAXP/1.1 RI XML parser available to all web
  applications, simply move the "jaxp.jar" and "crimson.jar" files from
  the "$TOMCAT_HOME/jasper" directory to the "$TOMCAT_HOME/lib" directory.

* If you wish to make another XML parser that is JAXP/1.1-compatible
  available to all web applications, install that parser into the
  "$TOMCAT_HOME/lib" directory and remove "jaxp.jar" and "crimson.jar"
  from the "$TOMCAT_HOME/jasper" directory.  It has been reported that
  Xerces 1.3.1 can be used in this fashion, but 2.x alpha releases
  can not be.

* If you wish to use an XML parser (such as Xerces) in the WEB-INF/lib
  directory of your web application, this should now be possible, because
  of the modified JAXP 1.1 parser mentioned below.

WARNING:  Tomcat 4.0 now ships with a modified version of the JAXP/1.1
(Final) "jaxp.jar" and "crimson.jar" files in the "jasper" subdirectory.
The "sealed" attribute has been removed from the manifest file for these
two JARs, to avoid "package sealing violation" errors that were caused by
them in a JDK 1.3 environment.  You MUST NOT replace these files with a
different (or later) release of JAXP, unless that later release has had
the sealed attribute removed, or you will encounter "package sealing violation"
errors when trying to use a different XML parser in a web application.
