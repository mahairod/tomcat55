<project name="Jasper" default="build-main" basedir=".">


  <!-- ===================== Initialize Property Values =================== -->
  <property name="ant.home"        value="../../jakarta-ant"/>
  <property name="build.compiler"  value="classic"/>
  <property name="jasper.build"    value="../../build/jasper"/>
  <property name="jasper.dist"     value="../../dist/jasper"/>
  <property name="jaxp.home"       value="../../jaxp"/>
  <property name="servletapi.home" value="../../jakarta-servletapi"/>
  <property name="catalina.build"   value="../../build/catalina"/>

  <!-- ================== Derived Property Values ========================= -->
  <property name="jaxp.jar"        value="${jaxp.home}/jaxp.jar"/>
  <property name="parser.jar"      value="${jaxp.home}/parser.jar"/>
  <property name="servlet.jar"     value="${servletapi.home}/lib/servlet.jar"/>


  <!-- =================== BUILD: Create Directories ====================== -->
  <target name="build-prepare">
    <mkdir dir="${jasper.build}"/>
    <mkdir dir="${jasper.build}/bin"/>
    <mkdir dir="${jasper.build}/classes"/>
    <mkdir dir="${jasper.build}/conf"/>
    <mkdir dir="${jasper.build}/lib"/>
    <mkdir dir="${jasper.build}/logs"/>
  </target>


  <!-- =================== BUILD: Copy Static Files ======================= -->
  <target name="build-static" depends="build-prepare">

    <!-- Executable Commands -->
    <copydir src="src/bin"  dest="${jasper.build}/bin"/>
    <fixcrlf srcdir="${jasper.build}/bin" includes="*.sh" cr="remove"/>
    <fixcrlf srcdir="${jasper.build}/bin" includes="*.bat" cr="add"/>
    <chmod perm="+x" file="${jasper.build}/bin/jasper.sh"/>
    <chmod perm="+x" file="${jasper.build}/bin/jspc.sh"/>

    <!-- Configuration Files -->
    <!-- <copydir src="src/conf" dest="${jasper.build}/conf"/> -->

    <!-- Shared Extensions -->
    <!--   All applications need the servlet API classes -->
    <copyfile src="${servlet.jar}" dest="${jasper.build}/lib/servlet.jar"/>
    <!--   Jasper needs a JAXP-compatible XML parser -->
    <copyfile src="${jaxp.jar}"    dest="${jasper.build}/lib/jaxp.jar"/>
    <copyfile src="${parser.jar}"  dest="${jasper.build}/lib/parser.jar"/>

  </target>


  <!-- ================= BUILD: Compile Server Components ================= -->
  <target name="build-main" depends="build-static">

    <!-- Compile internal server components -->
    <javac   srcdir="src/share" destdir="${jasper.build}/classes"
          classpath="${servlet.jar}"
        deprecation="off" debug="on" optimize="off"
           excludes="**/CVS/**"/>

    <!-- Copy static resource files -->
    <copydir  src="src/share"    dest="${jasper.build}/classes">
      <include name="**/*.properties"/>
    </copydir>

  </target>

  <!-- ================ BUILD: Create Jasper Javadocs ===================== -->
  <target name="javadoc" depends="build-main">
    <deltree dir="${catalina.build}/webapps/ROOT/jasper-javadoc"/>
    <mkdir dir="${catalina.build}/webapps/ROOT/jasper-javadoc"/>
    <javadoc packagenames="org.apache.jasper.*"
             classpath="${servlet.jar}:${jasper.build}/classes"
               sourcepath="src/share"
                  destdir="${catalina.build}/webapps/ROOT/jasper-javadoc"
                   author="true"
                  version="true"
              windowtitle="Jasper Internal API Documentation"
                 doctitle="Jasper API"
                   bottom="Copyright &#169; 2000 Apache Software Foundation.  All Rights Reserved."
    />
  </target>


  <!-- ======================= BUILD: Clean Directory ===================== -->
  <target name="build-clean">
    <deltree dir="${jasper.build}"/>
  </target>


  <!-- ==================== BUILD: Rebuild Everything ===================== -->
  <target name="all" depends="build-clean,build-main"/>


  <!-- ================ DIST: Create Directories ========================== -->
  <target name="dist-prepare">
    <mkdir dir="${jasper.dist}/bin"/>
    <mkdir dir="${jasper.dist}/lib"/>
  </target>


  <!-- ================ DIST: Copy Static Files =========================== -->
  <target name="dist-static" depends="dist-prepare, build-static">
    <copydir src="${jasper.build}/bin" dest="${jasper.dist}/bin"/>
    <fixcrlf srcdir="${jasper.dist}/bin" includes="*.sh" cr="remove"/>
    <fixcrlf srcdir="${jasper.dist}/bin" includes="*.bat" cr="add"/>
    <chmod perm="+x" file="${jasper.dist}/bin/jasper.sh"/>
    <chmod perm="+x" file="${jasper.dist}/bin/jspc.sh"/>
  </target>


  <!-- ================ DIST: Create Distribution ========================= -->
  <target name="dist" depends="dist-static, build-main">
    <jar jarfile="${jasper.dist}/lib/jasper.jar"
         basedir="${jasper.build}/classes" > 
         <include name="org/apache/jasper/**" /> 
    </jar>
  </target>


  <!-- ======================== DIST: Clean Directory ===================== -->
  <target name="dist-clean">
    <deltree dir="${jasper.dist}"/>
  </target>


  <!-- ================ DIST: Deploy for Catalina ========================= -->
  <target name="deploy" depends="dist">
    <copydir  src="${jasper.dist}/bin" dest="${catalina.build}/bin">
      <include name="j*"/>
    </copydir>
    <chmod perm="+x" file="${catalina.build}/bin/jasper.sh"/>
    <chmod perm="+x" file="${catalina.build}/bin/jspc.sh"/>
    <copyfile src="${jasper.dist}/lib/jasper.jar" dest="${catalina.build}/lib/jasper.jar"/>
  </target>


  <!-- ====================== Convenient Synonyms ========================= -->
  <target name="clean" depends="build-clean, dist-clean"/>


</project>

