package org.apache.jasper.compiler;

import java.util.*;
import java.net.URLEncoder;
import org.xml.sax.Attributes;
import org.apache.jasper.JasperException;
import org.apache.jasper.JspCompilationContext;
import org.apache.jasper.runtime.JspRuntimeLibrary;
import org.apache.jasper.Constants;

public class Generator {

    private ServletWriter out;
    private BeanRepository beanInfo;
    private JspCompilationContext ctxt;
    private boolean breakAtLF;
    private PageInfo pageInfo;

    /**
     * @param s the input string
     * @return quoted and escaped string, per Java rule
     */
    private String quote(String s) {

	if (s == null)
	    return "null";

	StringBuffer b = new StringBuffer();
	b.append('"');
	for (int i = 0; i < s.length(); i++) {
	    char c = s.charAt(i);
	    if (c == '"' || c == '\\')
		b.append('\\');
	    b.append(c);
	}
	b.append('"');
	return b.toString();
    }

    private void generateDeclarations(Node.Nodes page) throws JasperException {

	class DeclarationVisitor extends Node.Visitor {

	    public void visit(Node.PageDirective n) throws JasperException {
		String info = n.getAttributeValue("info");
		if (info == null)
		    return;

		out.printil("public String getServletInfo() {");
		out.pushIndent();
		out.printin("return \"");
		out.print(info);
		out.println("\";");
		out.popIndent();
		out.print('}');
		out.println();
	    }

	    public void visit(Node.Declaration n) throws JasperException {
		out.printMultiLn(new String(n.getText()));
	    }
	}

	out.println();
	page.visit(new DeclarationVisitor());
    }

    /**
     *
     */
    private void generatePreamble(Node.Nodes page) throws JasperException {

	String servletPackageName = ctxt.getServletPackageName();
	String servletClassName = ctxt.getServletClassName();
	String serviceMethodName = Constants.SERVICE_METHOD_NAME;
	String servletContentType = Constants.SERVLET_CONTENT_TYPE;

	// First the package name:

	if (! "".equals(servletPackageName) && servletPackageName != null) {
	    out.printil("package "+servletPackageName+";");
	    out.println();
        }

	// Generate imports

	Iterator iter = pageInfo.getImports().iterator();
	while (iter.hasNext()) {
	    out.printin("import ");
	    out.print((String)iter.next());
	    out.println(";");
	}
	out.println();

	// Generate class declaration

	out.printin("public class ");
	out.print(servletClassName);
	out.print(" extends ");
	out.print(pageInfo.getExtends());
	if (!pageInfo.isThreadSafe()) {
	    out.print("implements SingleThreadModel");
	}
	out.println(" {");

	// Class body begins here

	out.pushIndent();
	generateDeclarations(page);
	out.println();

	// Static initializations (none yet) here

	// Constructor (empty so far) here
	// Other methods here

	// Now the service method
	out.printin("public void ");
	out.print(serviceMethodName);
	out.println("(HttpServletRequest request, HttpServletResponse response)");
	out.println("        throws java.io.IOException, ServletException {");

	out.pushIndent();
	out.println();

	// Local variable declarations
	out.printil("JspFactory _jspxFactory = null;");
	out.printil("PageContext pageContext = null;");
	if (pageInfo.isSession())
	    out.printil("HttpSession session = null;");

	if (ctxt.isErrorPage())
            out.printil("Throwable exception = (Throwable) request.getAttribute(\"javax.servlet.jsp.jspException\");");

	out.printil("ServletContext application = null;");
	out.printil("ServletConfig config = null;");
	out.printil("JspWriter out = null;");
	out.printil("Object page = this;");

	out.printil("try {");
	out.pushIndent();

	out.printil("_jspxFactory = JspFactory.getDefaultFactory();");

	if (pageInfo.getContentType() != null) {
	    servletContentType = pageInfo.getContentType();
	    out.printin("response.setContentType(");
	    out.print(quote(servletContentType));
	    out.println(");");
	}
	else {
	    out.printin("response.setContentType(\"");
	    out.print(servletContentType);
	    out.println(";charset=ISO-8859-1\");");
	}

	out.printil("pageContext = _jspxFactory.getPageContext(" +
			"this, request, response,");
	out.printin("\t\t\t");
	out.print(quote(pageInfo.getErrorPage()));
	out.print(", " + pageInfo.isSession());
	out.print(", " + pageInfo.getBuffer());
	out.print(", " + pageInfo.isAutoFlush());
	out.println(");");

	out.printil("application = pageContext.getServletContext();");
	out.printil("config = pageContext.getServletConfig();");

	if (pageInfo.isSession())
	    out.printil("session = pageContext.getSession();");
	out.printil("out = pageContext.getOut();");
    }

    /**
     * A visitor that generates codes for the elements in the page.
     */
    class GenerateVisitor extends Node.Visitor {

	/**
	 * Returns an attribute value, optionally URL encoded.  If
	 * the value is a runtime expression, the result is the string for
	 * the expression, otherwise the result is the string literal,
	 * quoted and escaped.
	 * @param attr An JspAttribute object
	 * @param encode true if to be URL encoded
	 */
	private String attributeValue(Node.JspAttribute attr, boolean encode) {
	    String v = attr.getValue();
	    if (attr.isExpression())
		return v;
	    else {
		if (encode) 
		    v = URLEncoder.encode(v);
		return quote(v);
	    }
	}

	/**
	 * Prints the attribute value specified in the param action, in the
	 * form of name=value string.
	 *
	 * @param n the parent node for the param action nodes.
	 */
	private void printParams(Node n) throws JasperException {

	    class ParamVisitor extends Node.Visitor {
		char separator='?';

		public void visit(Node.ParamAction n) throws JasperException {

		    out.print(separator);
		    out.print(n.getAttributeValue("name"));
		    out.print('=');
		    out.print(attributeValue(n.getValue(), true));

		    // The separator is '&' after the second use
		    separator = '&';
		}
	    }

	    n.getBody().visit(new ParamVisitor());
	}

        public void visit(Node.Declaration n) throws JasperException {
	    out.printMultiLn(new String(n.getText()));
        }

        public void visit(Node.Expression n) throws JasperException {
	    out.print("out.print(" + new String(n.getText()) + ");");
        }

	public void visit(Node.Scriptlet n) throws JasperException {
	    out.printMultiLn(new String(n.getText()));
	}

	public void visit(Node.IncludeAction n) throws JasperException {

	    String flush = n.getAttributeValue("flush");

	    boolean isFlush = false;	// default to false;
	    if (flush != null && flush.equalsIgnoreCase("true"))
		isFlush = true;

	    out.printin("pageContext.include(request, response, ");
	    out.print(attributeValue(n.getPage(), true));
	    printParams(n);

	    out.println(", out, " + isFlush + ");");
        }

	public void visit(Node.ForwardAction n) throws JasperException {
	    String page = n.getAttributeValue("page");

	    out.printil("out.clear();");
	    out.printin("pageContext.forward(");
	    out.print(attributeValue(n.getPage(), true));
	    printParams(n);

	    out.println(");");
	    out.printil("return;");

	    // Not sure if we can eliminate dead codes after this.
	}

	public void visit(Node.GetProperty n) throws JasperException {
	    String name = n.getAttributeValue("name");
	    String property = n.getAttributeValue("property");

	    if (beanInfo.checkVariable(name)) {
		// Bean is defined using useBean, introspect at compile time
		Class bean = beanInfo.getBeanType(name);
		String beanName = bean.getName();
		java.lang.reflect.Method meth =
			JspRuntimeLibrary.getReadMethod(bean, property);
		String methodName = meth.getName();
		out.printil("out.print(JspRuntimeLibrary.toString(" +
			"(((" + beanName + ")pageContext.findAttribute(" +
			"\"" + name + "\"))." + methodName + "())));");
	    } else {
		// The object could be a custom action with an associated
		// VariableInfo entry for this name.
		// Get the class name and then introspect at runtime.
		out.printil("out.print(JspRuntimeLibrary.toString" +
			"(JspRuntimeLibrary.handleGetProperty" +
			"(pageContext.findAttribute(\"" +
			name + "\"), \"" + property + "\")));");
            }
        }

        public void visit(Node.SetProperty n) throws JasperException {
	    String name = n.getAttributeValue("name");
	    String property = n.getAttributeValue("property");
	    String param = n.getAttributeValue("param");
	    Node.JspAttribute value = n.getValue();

	    if ("*".equals(property)){
		out.printil("JspRuntimeLibrary.introspect(" +
				"pageContext.findAttribute(" +
				"\"" + name + "\"), request);");
	    }
	    else if (value == null) {
		if (param == null)
		    param = property;	// default to same as property
		out.printil("JspRuntimeLibrary.introspecthelper(" +
			"pageContext.findAttribute(\"" + name + "\"), \"" +
			property + "\", request.getParameter(\"" + param +
			"\"), " + "request, \"" + param + "\", false);");
	    }
	    else if (value.isExpression()) {
		out.printil("JspRuntimeLibrary.handleSetProperty(" + 
			"pageContext.findAttribute(\""  + name + "\"), \"" +
			property + "\","); 
		out.print(attributeValue(value, false));
		out.println(");");
	    }
	    else {
		out.printil("JspRuntimeLibrary.introspecthelper(" +
			"pageContext.findAttribute(\"" + name + "\"), \"" +
			property + "\",");
		out.print(attributeValue(value, false));
		out.println(",null, null, false);");
	    }
        }

        public void visit(Node.ParamsAction n) throws JasperException {
        }

        public void visit(Node.UseBean n) throws JasperException {
	    String name = n.getAttributeValue ("id");
	    String scope = n.getAttributeValue ("scope");
	    String clsname = n.getAttributeValue ("class");
	    String type = n.getAttributeValue ("type");
	    String beanName    = getAttribute ("beanName");

	    String scopename = "PageContext.PAGE_SCOPE"; // Default to page
	    String lock = "pageContext";

	    if ("request".equals(scope)) {
		scopename = "PageContext.REQUEST_SCOPE";
		lock = "request";
	    }
	    else if ("session".equals(scope)) {
		scopename = "PageContext.SESSION_SCOPE";
		lock = "session";
	    }
	    else if ("application".equals(scope)) {
		scopename = "PageContext.APPLICATION_SCOPE";
		lock = "application";
	    }

	    // 
	    visitBody(n);
        }
	
        public void visit(Node.PlugIn n) throws JasperException {
	    visitBody(n);
	}

        public void visit(Node.CustomTag n) throws JasperException {
	    visitBody(n);
        }

	public void visit(Node.UninterpretedTag n) throws JasperException {
	    visitBody(n);
        }

	private static final int CHUNKSIZE = 1024;

	public void visit(Node.TemplateText n) throws JasperException {

	    char[] chars = n.getText();
	    int size = chars.length;

	    out.printin();
	    StringBuffer sb = new StringBuffer("out.write(\"");
	    int initLength = sb.length();
	    int count = CHUNKSIZE;
	    for (int i = 0 ; i < size ; i++) {
		char ch = chars[i];
		--count;
		switch(ch) {
		case '"':
		    sb.append('\\');
		    sb.append('\"');
		    break;
		case '\\':
		    sb.append('\\');
		    sb.append('\\');
		    break;
		case '\r':
		    break;
		case '\n':
		    sb.append('\\');
		    sb.append('n');

		    if (breakAtLF || count < 0) {
			// Generate an out.write() when see a '\n' in template
			sb.append("\");");
			out.println(sb.toString());
			out.printin();
			sb.setLength(initLength);
			count = CHUNKSIZE;
		    }
		    break;
		case '\t':	// Not sure we need this
		    sb.append('\\');
		    sb.append('t');
		    break;
		default:
		    sb.append(ch);
	        }
	    }

	    if (sb.length() > initLength) {
		sb.append("\");");
  		out.println(sb.toString());
	    }
	}
    }

    private void generatePostamble(Node.Nodes page) {
        out.popIndent();
        out.printil("} catch (Throwable t) {");
        out.pushIndent();
        out.printil("if (out != null && out.getBufferSize() != 0)");
        out.pushIndent();
        out.printil("out.clearBuffer();");
        out.popIndent();
        out.printil("if (pageContext != null) pageContext.handlePageException(t);");
        out.popIndent();
        out.printil("} finally {");
        out.pushIndent();

        /* Do stuff here for finally actions... */
        out.printil("if (_jspxFactory != null) _jspxFactory.releasePageContext(pageContext);");
        out.popIndent();
        out.printil("}");

        // Close the service method:
        out.popIndent();
        out.printil("}");

        // Close the class definition:
        out.popIndent();
        out.printil("}");
    }

    Generator(ServletWriter out, Compiler compiler) {
	this.out = out;
	ctxt = compiler.getCompilationContext();
	pageInfo = compiler.getPageInfo();
	beanInfo = pageInfo.getBeanRepository();
	breakAtLF = ctxt.getOptions().getMappedFile();
    }

    public static void generate(ServletWriter out, Compiler compiler,
				Node.Nodes page) throws JasperException {
	Generator gen = new Generator(out, compiler);

	gen.generatePreamble(page);
	page.visit(gen.new GenerateVisitor());
	gen.generatePostamble(page);
    }
}

